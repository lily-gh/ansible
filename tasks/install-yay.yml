---
- name: Install yay AUR helper on Arch
  hosts: localhost
  gather_facts: true
  vars:
    aur_builder_user: "{{ ansible_user_id }}"
    aur_build_dir: "/tmp/yay"

  tasks:
    - name: Ensure base-devel and git are installed
      become: true
      ansible.builtin.pacman:
        name:
          - base-devel
          - git
        state: present

    - name: Ensure aur_builder user can run pacman without password
      become: true
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/aur_builder
        create: true
        mode: '0440'
        line: "{{ aur_builder_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman -S*, /usr/bin/pacman -U*"

    - name: Clean yay build directory
      ansible.builtin.file:
        path: "{{ aur_build_dir }}"
        state: absent

    - name: Clone yay repository
      ansible.builtin.git:
        repo: "https://aur.archlinux.org/yay.git"
        dest: "{{ aur_build_dir }}"
        update: yes

    - name: Build yay package as normal user (non-interactive)
      ansible.builtin.shell: |
        cd {{ aur_build_dir }}
        # Pre-seed sudo cache to avoid "a terminal is required" error
        sudo -v
        # Run makepkg non-interactively
        makepkg -si --noconfirm
      args:
        executable: /bin/bash
      environment:
        SUDO_ASKPASS: /usr/bin/true
      become: false

    - name: Verify yay installation
      ansible.builtin.command: yay --version
      register: yay_version
      changed_when: false

    - name: Show yay version
      ansible.builtin.debug:
        var: yay_version.stdout

    - name: Remove temporary sudoers rule
      become: true
      ansible.builtin.file:
        path: /etc/sudoers.d/aur_builder
        state: absent
